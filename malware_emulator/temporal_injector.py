from pynput import keyboard
from Quartz import CGEventCreateKeyboardEvent, CGEventPost, kCGHIDEventTap
import time
import random

# TEMPORAL KIA EXAMPLE
# When user types 'w', inject a lowercase 'w' by simulating Delete + w

# macOS Key Codes
KEY_DELETE = 51
KEY_w = 13

def human_delay():
    time.sleep(random.uniform(0.002, 0.003))  # more human natural delay

def inject_delete_and_retype_w():
    # Delete original character
    delete_down = CGEventCreateKeyboardEvent(None, KEY_DELETE, True)
    CGEventPost(kCGHIDEventTap, delete_down)
    human_delay()
    delete_up = CGEventCreateKeyboardEvent(None, KEY_DELETE, False)
    CGEventPost(kCGHIDEventTap, delete_up)
    print("⌫ Deleted user 'w'")

    human_delay()

    # Retype lowercase 'w'
    w_down = CGEventCreateKeyboardEvent(None, KEY_w, True)
    CGEventPost(kCGHIDEventTap, w_down)
    human_delay()
    w_up = CGEventCreateKeyboardEvent(None, KEY_w, False)
    CGEventPost(kCGHIDEventTap, w_up)
    print("Re-injected lowercase 'w'")

# Only trigger after keyup of 'w'
def on_release(key):
    try:
        if key.char == 'w':
            inject_delete_and_retype_w()
    except AttributeError:
        pass

# Start listener
with keyboard.Listener(on_release=on_release) as listener:
    print("Waiting for 'w' key release… Press Ctrl+C to quit.")
    listener.join()
