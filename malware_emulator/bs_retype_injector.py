from pynput import keyboard
from Quartz import CGEventCreateKeyboardEvent, CGEventPost, kCGHIDEventTap
import time
import random

# TEMPORAL KIA EXAMPLE
# When user types 'w', inject a lowercase 'w' by simulating backspace + w

# macOS Key Codes
KEY_DELETE = 51
KEY_w = 13

def human_delay():
    time.sleep(random.uniform(0.001, 0.03))

def inject_delete_and_retype_w():
    # Delete original character
    delete_down = CGEventCreateKeyboardEvent(None, KEY_DELETE, True)
    delete_up = CGEventCreateKeyboardEvent(None, KEY_DELETE, False)
    w_down = CGEventCreateKeyboardEvent(None, KEY_w, True)
    w_up = CGEventCreateKeyboardEvent(None, KEY_w, False)
    
    human_delay()
    CGEventPost(kCGHIDEventTap, delete_down)
    human_delay()
    CGEventPost(kCGHIDEventTap, w_down)
    human_delay()
    CGEventPost(kCGHIDEventTap, delete_up)
    human_delay()
    CGEventPost(kCGHIDEventTap, w_up)
    print("Re-injected lowercase 'w'")

# Only trigger after keyup of 'w'
def on_release(key):
    try:
        if key.char == 'w':
            inject_delete_and_retype_w()
    except AttributeError:
        pass

# Start listener
with keyboard.Listener(on_release=on_release) as listener:
    print("Waiting for 'w' key releaseâ€¦")
    listener.join()
