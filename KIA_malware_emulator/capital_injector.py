from pynput import keyboard
from Quartz import CGEventCreateKeyboardEvent, CGEventPost, kCGHIDEventTap
import time

# When user types 'w', inject a capital 'W' by simulating Delete + Shift + w
# NOTE: This code fires when keydown of w is detected, not when the key is released. Keyup for the first w key pressed doesn't exist which is a problem.

# Key codes (macOS)
KEY_DELETE = 51
KEY_SHIFT = 56
KEY_w = 13

def inject_capital_w():
    # Delete the lowercase 'w' the user typed
    delete_down = CGEventCreateKeyboardEvent(None, KEY_DELETE, True)
    delete_up = CGEventCreateKeyboardEvent(None, KEY_DELETE, False)
    CGEventPost(kCGHIDEventTap, delete_down)
    CGEventPost(kCGHIDEventTap, delete_up)

    time.sleep(0.001)

    # Press and hold Shift key
    shift_down = CGEventCreateKeyboardEvent(None, KEY_SHIFT, True)
    CGEventPost(kCGHIDEventTap, shift_down)

    time.sleep(0.001)

    # Press and release 'w'
    w_down = CGEventCreateKeyboardEvent(None, KEY_w, True)
    CGEventPost(kCGHIDEventTap, w_down)
    time.sleep(0.001)
    w_up = CGEventCreateKeyboardEvent(None, KEY_w, False)
    CGEventPost(kCGHIDEventTap, w_up)

    time.sleep(0.001)

    # Release Shift
    shift_up = CGEventCreateKeyboardEvent(None, KEY_SHIFT, False)
    CGEventPost(kCGHIDEventTap, shift_up)

    print("âœ… Injected Shift + w as capital 'W'")

# Listen for 'w' key
def on_press(key):
    try:
        if key.char == 'w':
            inject_capital_w()
    except AttributeError:
        pass

# Start key listener
with keyboard.Listener(on_press=on_press) as listener:
    print("ðŸ§ª Listening for 'w' keyâ€¦ Press Ctrl+C to exit.")
    listener.join()
